---
import { getCollection } from "astro:content";
import PostList from "./PostList.astro";
import Card from "./Card.astro";
import Button from "./Button.astro";

interface Props {
	currentSlug: string;
	currentTags: string[];
	count?: number;
}

const { currentSlug, currentTags, count = 4 } = Astro.props;

// Normaliser les tags pour comparaison (insensible aux accents et à la casse)
function normalizeTag(tag: string): string {
	return tag
		.normalize("NFD")
		.replace(/[\u0300-\u036f]/g, "")
		.toLowerCase();
}

const allPosts = await getCollection("posts");

// Calculer le score de pertinence pour chaque post
const scoredPosts = allPosts
	.filter((post) => post.id !== currentSlug) // Exclure l'article courant
	.map((post) => {
		const postTags = post.data.tags || [];
		const normalizedCurrentTags = currentTags.map(normalizeTag);
		const normalizedPostTags = postTags.map(normalizeTag);

		// Compter les tags en commun
		const commonTags = normalizedPostTags.filter((tag) =>
			normalizedCurrentTags.includes(tag)
		).length;

		// Score = tags en commun / total de tags de l'article courant
		const score =
			currentTags.length > 0 ? commonTags / currentTags.length : 0;

		return {
			post,
			score,
			commonTags,
		};
	})
	.filter((item) => item.commonTags >= 1) // Au moins 1 tag en commun
	.sort((a, b) => {
		// Trier par score décroissant, puis par date de publication
		if (b.score !== a.score) {
			return b.score - a.score;
		}
		return b.post.data.pubDate.getTime() - a.post.data.pubDate.getTime();
	})
	.slice(0, count);

const relatedPosts = scoredPosts.map((item) => item.post);
---

{
	relatedPosts.length > 0 && (
		<section class="mt-8">
			<Card>
				<div class="flex justify-between items-start p-4 dark:bg-black rounded-lg">
					<h2
						class:list={[
							"text-2xl md:text-4xl lg:text-6xl mb-8 dm-serif",
							"dark:text-[#fff6d2]",
						]}
					>
						Articles Connexes
					</h2>
					<div class="hidden md:block">
						<Button href="/blog">Tous les articles &rarr;</Button>
					</div>
					<div class="block md:hidden">
						<Button href="/blog">Blog</Button>
					</div>
				</div>
				<div class="dark:bg-black rounded-lg">
					<PostList posts={relatedPosts} />
				</div>
			</Card>
		</section>
	)
}
